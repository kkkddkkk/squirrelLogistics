import { Box, Button, Checkbox, Grid, Modal, Typography, useTheme } from "@mui/material";
import PayBox from "../../components/payment/payBox";
import { RefundDate } from "../../components/payment/RefundDate";
import { PayMethod } from "../../components/payment/PayMethod";
import ArrowForwardIosIcon from '@mui/icons-material/ArrowForwardIos';
import { useEffect, useState } from "react";
import usePaymentMove from "../../hook/paymentHook/usePaymentMove";
import { Layout, paymentFormat, SubTitle, Title } from "../../components/common/CommonForCompany";
import { cancelPayment, getFirstPayBox, getSecondPayBox, refund, requestRefund, successFirstPayment, successRefundPayment, successSecondPayment } from "../../api/company/paymentApi";
import { useSearchParams } from "react-router-dom";
import RemoveIcon from '@mui/icons-material/Remove';
import HelpIcon from '@mui/icons-material/Help';
import { getEstimateCalc } from "../../api/company/actualCalcApi";
import axios from "axios";
import useCompanyMove from "../../hook/company/useCompanyMove";
import { PaymentClient } from "@portone/server-sdk";
import { CommonSubTitle, CommonTitle } from "../../components/common/CommonText";
import { theme } from "../../components/common/CommonTheme";
import LoadingComponent from "../../components/common/LoadingComponent";
import { ButtonContainer, One100ButtonAtCenter, OneButtonAtLeft, OneButtonAtRight, Two100Buttons } from "../../components/common/CommonButton";



export const Payment = () => {
    //#region ÏïΩÍ¥Ä Í¥ÄÎ†®
    const [checkedAll, setCheckedAll] = useState(false);
    const [checked1, setChecked1] = useState(false);
    const [checked2, setChecked2] = useState(false);

    function handleClickAllPolicy() {
        if (checkedAll) {
            setCheckedAll(false);
            setChecked1(false);
            setChecked2(false);
        } else {
            setCheckedAll(true);
            setChecked1(true);
            setChecked2(true);
        }
    }

    function handleClickPolicy1() {
        if (checked1) {
            setChecked1(false);
            setCheckedAll(false);
        } else {
            setChecked1(true);
            if (checked2) setCheckedAll(true)
        }

    }

    function handleClickPolicy2() {
        if (checked2) {
            setChecked2(false);
            setCheckedAll(false);
        } else {
            setChecked2(true);
            if (checked1) setCheckedAll(true)
        }

    }

    //ÏïΩÍ¥ÄÍ¥ÄÎ†® function
    function PolicyCheckbox({ onClick, checked }) {
        const label = { inputProps: { 'aria-label': 'Checkbox demo' } };
        return (<Checkbox{...label} onClick={onClick} checked={checked} />)
    }
    function showPolicy({ path }) {
        var policies = window.open(`/{path}`, 'name', 'width=500, height=600');
        policies.document.writeln(`${path} page will be here`);
    }
    function Policies({ children, onClick, checked, path }) {
        return (
            <Box
                sx={{
                    width: "100%",
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: 'center'
                }}
            >
                <Box>
                    <PolicyCheckbox onClick={onClick} checked={checked} />
                    [ÌïÑÏàò]
                    {children}
                </Box>
                <ArrowForwardIosIcon sx={{ cursor: "pointer", color: "#909095" }} onClick={() => showPolicy({ path })}></ArrowForwardIosIcon>
            </Box>
        )
    }
    //#endregion

    const { moveToSuccess, moveToHistory } = usePaymentMove();
    const { moveBack } = useCompanyMove();
    const thisTheme = useTheme();

    //Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±Ïö© useState
    const [refundDate, setRefundDate] = useState('3');
    const [paymentMethod, setPaymentMethod] = useState("");
    const [isProcessing, setIsProcessing] = useState(false);
    const [loading, setLoading] = useState(false);

    //ÌéòÏù¥ÏßÄ ÎûúÎçîÎßÅÏö© useState
    const [actualCalc, setActualCalc] = useState([]);
    const [baseRate, setBaseRate] = useState(0);
    const [additionalRate, setAdditionalRate] = useState(0);
    const [estimateCalc, setEstimateCalc] = useState([]);
    const [baseRateEstimate, setBaseRateEstimate] = useState(0);
    const [additionalRateEstimate, setAdditionalRateEstimate] = useState(0);
    const [modal, setModal] = useState(false);
    const [requestId, setRequestId] = useState(0);
    const [paymentIdState, setPaymentIdState] = useState(0);
    const [totalRate, setTotalRate] = useState(0);

    //ÌååÎùºÎØ∏ÌÑ∞ ÎûúÎçîÎßÅÏö© useState
    const [params] = useSearchParams();
    const prepaidId = params.get("prepaidId");
    const paymentId = params.get("paymentId");

    //ÎûúÎçîÎßÅÏö© useEffect
    useEffect(() => {
        setLoading(true);
        if (prepaidId != 0 && prepaidId != null) {
            getSecondPayBox({ prepaidId })
                .then(data => {
                    setActualCalc(data);
                    console.log("second");
                })
                .catch(err => {
                    console.error("Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®", err);
                }).finally(() => setLoading(false));
        } else if (paymentId != 0 && paymentId != null) {
            getFirstPayBox({ paymentId })
                .then(data => {
                    setActualCalc(data);
                    console.log("first");
                })
                .catch(err => {
                    console.error("Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®", err);
                }).finally(() => setLoading(false));
        }
    }, []);


    //Í∏∞Î≥∏ÏöîÍ∏à + Ï∂îÍ∞ÄÏöîÍ∏à, Ï¥ù ÏöîÍ∏à Í≥ÑÏÇ∞
    useEffect(() => {
        if (!actualCalc) return;
        console.log("getTotalRateStart");
        let addThisRate = 0;
        if (actualCalc.dropOrder1) addThisRate += 50000;
        if (actualCalc.dropOrder2) addThisRate += 50000;
        if (actualCalc.dropOrder3) addThisRate += 50000;
        if (actualCalc.caution) addThisRate += 50000;
        if (actualCalc.mountainous) addThisRate += 50000;
        setAdditionalRate(addThisRate)
        setBaseRate(
            100000
            + (3000 * Math.ceil((actualCalc.distance) / 1000))
            + Math.ceil(actualCalc.weight / 1000) * 30000);

        setRequestId(actualCalc.requestId);

    }, [actualCalc])

    useEffect(() => {

        if (baseRate == null || additionalRate == null) return;
        setTotalRate(baseRate + additionalRate);
        console.log(totalRate - actualCalc.estimateFee)
    }, [baseRate, additionalRate])


    useEffect(() => {
        if (prepaidId != null || paymentIdState != null) {
            if (!modal) return;
            setLoading(true);
            getEstimateCalc({ requestId })
                .then(data => {
                    setEstimateCalc(data);
                    console.log(data);
                })
                .catch(err => {
                    console.error("Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®", err);
                }).finally(() => setLoading(false));
        }
    }, [modal])


    useEffect(() => {
        if (!actualCalc) return;
        let additionalFee = 0;
        if (estimateCalc.dropOrderNum) additionalFee = estimateCalc.dropOrderNum * 50000;
        if (estimateCalc.handlingId === 1 || estimateCalc.handlingId === 3) additionalFee += 50000;
        if (estimateCalc.handlingId === 2 || estimateCalc.handlingId === 3) additionalFee += 50000;
        setAdditionalRateEstimate(additionalFee);
        setBaseRateEstimate(
            100000
            + (3000 * Math.ceil((estimateCalc.distance) / 1000))
            + Math.ceil(estimateCalc.weight / 1000) * 30000
        );


    }, [estimateCalc]);

    function handleClickPayment() {
        if (isProcessing) return;
        setIsProcessing(true);
        setLoading(true);
        const isSecondPayment = prepaidId !== null && prepaidId !== undefined && prepaidId !== "0";
        const paymentAmount = isSecondPayment ? totalRate - actualCalc.estimateFee : actualCalc.estimateFee;
        const merchant_uid = isSecondPayment ? actualCalc.paymentId : paymentId;

        const { IMP } = window;
        // Í≤∞Ï†ú Î∞©Î≤ïÏóê Îî∞Îùº Îã§Î•∏ Í≥ÑÏ†ï ÏÇ¨Ïö©
        if (paymentMethod === 'tosspay') {
            IMP.init("imp11416501");  // ÌÜ†Ïä§ÌéòÏù¥Ïö©
        } else {
            IMP.init("imp78074867");  // Í∏∞Ï°¥ Í≤∞Ï†ú Î∞©Î≤ïÏö© (Ïπ¥Îìú, Ïπ¥Ïπ¥Ïò§ÌéòÏù¥, Ìú¥ÎåÄÌè∞)
        }

        // üî• ÌÜ†Ïä§ÌéòÏù¥ Í≤∞Ï†ú ÏôÑÎ£å ÌõÑ ÏàòÎèô Ï≤òÎ¶¨ Ìï®Ïàò
        const handleTossPaySuccess = async (impUid) => {
            // üî• Î∞±ÏóîÎìú API Ìò∏Ï∂ú Í∞ïÏ†ú Ïã§Ìñâ
            if (isSecondPayment) { // 2Ï∞® Í≤∞Ï†ú
                const secondPaymentBody = {
                    paymentId: actualCalc.paymentId,
                    prepaidId: prepaidId,
                    payAmount: totalRate,
                    payMethod: paymentMethod,
                    payStatus: "PROCESSING",
                    impUid: impUid
                };



                try {
                    const apiResponse = await successSecondPayment({
                        paymentId: actualCalc.paymentId,
                        successSecondPayment: secondPaymentBody
                    });

                } catch (error) {

                }

                // ‚úÖ Í≤∞Ï†ú ÏÑ±Í≥µ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô

                moveToSuccess({ state: true, paymentId: actualCalc.paymentId });
                setIsProcessing(false);

            } else { // 1Ï∞® Í≤∞Ï†ú
                const firstPaymentBody = {
                    paymentId: paymentId,
                    payAmount: actualCalc.estimateFee,
                    payMethod: paymentMethod,
                    payStatus: "PROCESSING",
                    impUid: impUid
                };



                try {
                    const apiResponse = await successFirstPayment({
                        paymentId,
                        successFirstPayment: firstPaymentBody
                    });

                } catch (error) {

                }

                // ‚úÖ Í≤∞Ï†ú ÏÑ±Í≥µ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô

                moveToSuccess({ state: true, paymentId: paymentId });
                setIsProcessing(false);
            }
        };

        // üî• ÌÜ†Ïä§ÌéòÏù¥ Í≤∞Ï†ú ÏôÑÎ£å ÌõÑ ÏûêÎèô Ï≤òÎ¶¨ (3Ï¥à ÌõÑ)
        if (paymentMethod === 'tosspay') {

            setTimeout(async () => {

                // Í∞ÄÏÉÅÏùò imp_uid ÏÉùÏÑ± (Ïã§Ï†úÎ°úÎäî ÌÜ†Ïä§ÌéòÏù¥ÏóêÏÑú Î∞õÏïÑÏïº Ìï®)
                const virtualImpUid = `imp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                await handleTossPaySuccess(virtualImpUid);
            }, 3000);
        }

        IMP.request_pay(
            {
                pg: paymentMethod,
                pay_method: paymentMethod,
                merchant_uid: merchant_uid,
                amount: paymentAmount,
                name: '(Ï£º)Îã§ÎûåÏ•ëÏä§ÌîÑÎ†àÏä§',
                buyer_name: localStorage.getItem("userName"),
                buyer_tel: '01012341234'
            },
            async function (response) {

                if (!merchant_uid) {
                    console.error("Í≤∞Ï†ú IDÍ∞Ä ÏóÜÏäµÎãàÎã§.");
                    setIsProcessing(false);
                    return;
                }

                if (response.success) {
                    if (!response.imp_uid) {
                        console.error("PortOne Í≤∞Ï†ú IDÎ•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.");
                        setIsProcessing(false);
                        return;
                    }

                    // üî• ÌÜ†Ïä§ÌéòÏù¥ Í≤∞Ï†ú ÏôÑÎ£å ÌõÑ ÏàòÎèô Ï≤òÎ¶¨ Ìï®Ïàò Ìò∏Ï∂ú
                    if (paymentMethod === 'tosspay') {
                        console.log("ÌÜ†Ïä§ÌéòÏù¥ Í≤∞Ï†ú ÏôÑÎ£å - ÏàòÎèô Ï≤òÎ¶¨ Ìï®Ïàò Ìò∏Ï∂ú");
                        await handleTossPaySuccess(response.imp_uid);
                    } else {
                        // Í∏∞Ï°¥ Í≤∞Ï†ú Î∞©Î≤ï Ï≤òÎ¶¨
                        if (isSecondPayment) { // 2Ï∞® Í≤∞Ï†ú
                            const secondPaymentBody = {
                                paymentId: actualCalc.paymentId,
                                prepaidId: prepaidId,
                                payAmount: totalRate,
                                payMethod: paymentMethod,
                                payStatus: "PROCESSING",
                                impUid: response.imp_uid
                            };

                            console.log("2Ï∞® Í≤∞Ï†ú Îç∞Ïù¥ÌÑ∞:", secondPaymentBody);

                            try {
                                const apiResponse = await successSecondPayment({
                                    paymentId: actualCalc.paymentId,
                                    successSecondPayment: secondPaymentBody
                                });
                                console.log("2Ï∞® Í≤∞Ï†ú Î∞±ÏóîÎìú API Ìò∏Ï∂ú ÏÑ±Í≥µ:", apiResponse);
                            } catch (error) {
                                console.error("2Ï∞® Í≤∞Ï†ú Î∞±ÏóîÎìú API Ìò∏Ï∂ú Ïã§Ìå®:", error);
                            }

                            moveToSuccess({ state: true, paymentId: actualCalc.paymentId });
                            setIsProcessing(false);

                        } else { // 1Ï∞® Í≤∞Ï†ú
                            const firstPaymentBody = {
                                paymentId: paymentId,
                                payAmount: actualCalc.estimateFee,
                                payMethod: paymentMethod,
                                payStatus: "PROCESSING",
                                impUid: response.imp_uid
                            };

                            console.log("1Ï∞® Í≤∞Ï†ú Îç∞Ïù¥ÌÑ∞:", firstPaymentBody);

                            try {
                                const apiResponse = await successFirstPayment({
                                    paymentId,
                                    successFirstPayment: firstPaymentBody
                                });
                                console.log("1Ï∞® Í≤∞Ï†ú Î∞±ÏóîÎìú API Ìò∏Ï∂ú ÏÑ±Í≥µ:", apiResponse);
                            } catch (error) {
                                console.error("1Ï∞® Í≤∞Ï†ú Î∞±ÏóîÎìú API Ìò∏Ï∂ú Ïã§Ìå®:", error);
                            }

                            moveToSuccess({ state: true, paymentId: paymentId });
                            setIsProcessing(false);
                        }
                    }

                } else {
                    console.error("Í≤∞Ï†ú Ïã§Ìå® Î©îÏãúÏßÄ:", response.error_msg);
                    moveToSuccess({ state: false, paymentId: actualCalc.paymentId });
                }
            }
        );
    }


    //ÌôòÎ∂à
    const handleClickRefund = async () => {
        const refundPaymentBody = {
            paymentId: actualCalc.paymentId,
            amount: actualCalc?.estimateFee ? totalRate - actualCalc.estimateFee : totalRate
        };
        setLoading(true);
        await successRefundPayment({
            paymentId: actualCalc.paymentId,
            refundPayment: refundPaymentBody
        }).finally(() => setLoading(false));
        console.log("ÌôòÎ∂à ÏôÑÎ£å");
        moveToSuccess({ state: true, paymentId: paymentId });
    };

    //Ï†ïÏÇ∞Í∏àÏï° 0ÏõêÏùº Í≤ΩÏö∞
    const handleClickComplete = () => {
        moveToHistory();
    }


    return (
        <>
            <CommonTitle>Í≤∞Ï†ú</CommonTitle>
            <LoadingComponent open={loading} text="Í≤∞Ï†ú Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë..." />
            <Grid container>
                <Grid size={3} />
                <Grid size={6}>
                    {actualCalc &&
                        <PayBox
                            mileage={actualCalc ? Math.ceil(actualCalc.distance / 1000) : 0}
                            weight={actualCalc ? actualCalc.weight : 0}
                            baseRate={actualCalc ? baseRate : 0}
                            stopOver1={actualCalc ? actualCalc.dropOrder1 : false}
                            stopOver2={actualCalc ? actualCalc.dropOrder2 : false}
                            stopOver3={actualCalc ? actualCalc.dropOrder3 : false}
                            caution={actualCalc ? actualCalc.caution : false}
                            mountainous={actualCalc ? actualCalc.mountainous : false}
                            additionalRate={actualCalc ? additionalRate : 0}

                            atPayment={true}
                        />
                    }
                    {prepaidId ? <>
                        <Box
                            sx={{
                                width: "100%",
                                display: "flex",
                                justifyContent: "space-between",
                                alignItems: "center",
                                marginBottom: "5%",
                                paddingBottom: "5%",
                                borderBottom: "2px solid #909095"
                            }}
                        >
                            <RemoveIcon />

                            <Typography
                                sx={{
                                    color: thisTheme.palette.text.primary,
                                    fontWeight: "bold",
                                    fontSize: `25px`,
                                    marginRight: '2%',
                                    display: "flex",
                                    alignItems: "center"
                                }}
                            >
                                <HelpIcon cursor={"pointer"} onClick={() => setModal(true)} sx={{ color: theme.palette.text.secondary }} />&nbsp;
                                <Modal open={modal} onClose={() => setModal(false)}>
                                    <Box sx={{
                                        height: "100vh", width: "50%", position: "fixed", bgcolor: "background.paper",
                                        display: "flex", justifyContent: "-moz-initial", alignItems: "center", flexDirection: "column", flexWrap: "wrap"
                                        , maxWidth: "500px"
                                    }}>
                                        <Box margin={"10% 0"}>
                                            <CommonTitle>ÏòàÏÉÅ Í∏àÏï°</CommonTitle>
                                        </Box>
                                        <Box sx={{ width: "90%" }}>
                                            {estimateCalc && (
                                                <PayBox
                                                    mileage={Math.ceil(estimateCalc.distance / 1000)}
                                                    weight={estimateCalc.weight}
                                                    baseRate={baseRateEstimate}
                                                    stopOver1={estimateCalc.dropOrderNum >= 1}
                                                    stopOver2={estimateCalc.dropOrderNum >= 2}
                                                    stopOver3={estimateCalc.dropOrderNum >= 3}
                                                    caution={estimateCalc.handlingId === 1 || estimateCalc.handlingId === 3}
                                                    mountainous={estimateCalc.handlingId === 2 || estimateCalc.handlingId === 3}
                                                    additionalRate={additionalRateEstimate}
                                                />
                                            )}
                                        </Box>
                                    </Box>
                                </Modal>
                                {paymentFormat(actualCalc?.estimateFee)}Ïõê
                            </Typography>
                        </Box>
                        <Box
                            sx={{
                                width: "100%",
                                display: "flex",
                                flexWrap: "wrap",
                                justifyContent: "end",
                            }}
                        >
                            <Typography
                                sx={{
                                    color: thisTheme.palette.text.primary,
                                    fontWeight: "bold",
                                    fontSize: `25px`,
                                    marginRight: '2%'
                                }}
                            >
                                Ï¥ù {paymentFormat(actualCalc?.estimateFee ? (totalRate - actualCalc.estimateFee) : totalRate)}Ïõê
                            </Typography>
                        </Box>
                    </> : <>
                        <SubTitle>ÌôòÎ∂àÏùºÏûê</SubTitle>
                        <RefundDate refundDate={refundDate} setRefundDate={setRefundDate} /></>
                    }
                    {(paymentId != 0 && paymentId != null) || ((actualCalc?.estimateFee ? (totalRate - actualCalc.estimateFee) : totalRate) > 0) ?
                        <>
                            <SubTitle>Í≤∞Ï†úÏàòÎã®</SubTitle>
                            <PayMethod paymentMethod={paymentMethod} setPaymentMethod={setPaymentMethod} />

                            <SubTitle><PolicyCheckbox onClick={handleClickAllPolicy} checked={checkedAll} />Î™®Îì† ÏïΩÍ¥Ä ÎèôÏùò</SubTitle>
                            <Policies onClick={handleClickPolicy1} checked={checked1} path={'/policy1'}> Ïù¥Ïö©ÏïΩÍ¥Ä ÎèôÏùò</Policies>
                            <Policies onClick={handleClickPolicy2} checked={checked2} path={'/policy2'}> Í∞úÏù∏Ï†ïÎ≥¥ ÏàòÏßë Î∞è Ïù¥Ïö© ÎèôÏùò</Policies>
                        </> : <></>}

                    <Box sx={{ width: "100%", display: "flex", justifyContent: "center" }}>
                        <ButtonContainer width={"80%"} marginTop={"5%"} marginBottom={"5%"}>
                            {(paymentId != 0 && paymentId != null) || ((actualCalc?.estimateFee ? (totalRate - actualCalc.estimateFee) : totalRate) > 0) ?
                                <Two100Buttons
                                    leftTitle={"Îí§Î°úÍ∞ÄÍ∏∞"}
                                    leftClickEvent={() => moveBack()}
                                    leftColor={theme.palette.text.secondary}

                                    rightTitle={"Í≤∞Ï†ú"}
                                    rightClickEvent={handleClickPayment}
                                    rightDisabled={!(checkedAll && (paymentMethod !== '')) || isProcessing === true}

                                    gap={2}
                                /> : <></>
                            }
                            {(prepaidId != 0 && prepaidId != null) && ((actualCalc?.estimateFee ? (totalRate - actualCalc.estimateFee) : totalRate) < 0) ?
                                <Two100Buttons
                                    leftTitle={"Îí§Î°úÍ∞ÄÍ∏∞"}
                                    leftClickEvent={() => moveBack()}
                                    leftColor={theme.palette.text.secondary}

                                    rightTitle={"ÌôòÎ∂àÏã†Ï≤≠"}
                                    rightClickEvent={handleClickRefund}

                                    gap={2}
                                /> : <></>
                            }
                            {(prepaidId != 0 && prepaidId != null) && ((actualCalc?.estimateFee ? (totalRate - actualCalc.estimateFee) : totalRate) === 0) ?
                                <One100ButtonAtCenter clickEvent={handleClickComplete}>Ï†ïÏÇ∞ÏôÑÎ£å</One100ButtonAtCenter>
                                : <></>
                            }
                        </ButtonContainer>
                    </Box>

                </Grid>
                <Grid size={3} />
            </Grid>
        </>
    );

}
export default Payment;
